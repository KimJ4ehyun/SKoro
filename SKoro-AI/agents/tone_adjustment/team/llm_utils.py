"""
íŒ€ì¥ìš© LLM ì²˜ë¦¬ ë° JSON íŒŒì‹± ìœ í‹¸ë¦¬í‹° (ê¸€ììˆ˜ ì œí•œ ê°•í™” ë²„ì „)
Team manager LLM processing and JSON parsing utilities (enhanced character limit version)
"""

import json
from typing import Dict, Any
from langchain_openai import ChatOpenAI
from langchain.schema import HumanMessage, SystemMessage

class ManagerLLMClient:
    """íŒ€ì¥ìš© LLM í´ë¼ì´ì–¸íŠ¸"""
    
    def __init__(self, llm_client: ChatOpenAI):
        self.client = llm_client
    
    def get_manager_tone_correction_prompt(self, report_type) -> str:
        """íŒ€ì¥ìš© ë ˆí¬íŠ¸ í†¤ ë³´ì • í”„ë¡¬í”„íŠ¸ ë°˜í™˜ (ê¸€ììˆ˜ ì œí•œ ê°•í™”)"""
        base_prompt = """
# íŒ€ì¥ìš© ë ˆí¬íŠ¸ í†¤ ë³´ì • í”„ë¡¬í”„íŠ¸ (ê¸€ììˆ˜ ì œí•œ ê°•í™” ë²„ì „)

## âš ï¸ ìµœìš°ì„  ê·œì¹™: 200ì ê¸€ììˆ˜ ì œí•œ (ì ˆëŒ€ ì¤€ìˆ˜)

### ğŸ“ ê¸€ììˆ˜ ì œí•œ ê·œì¹™ (ë°˜ë“œì‹œ ì¤€ìˆ˜)
* **ëŒ€ìƒ**: `íŒ€ì›_ì„±ê³¼_ë¶„ì„` â†’ `íŒ€ì›ë³„_ê¸°ì—¬ë„` â†’ ê° íŒ€ì›ì˜ `ê¸°ì—¬_ë‚´ìš©` í•„ë“œ
* **ì œí•œ**: ê° íŒ€ì›ì˜ `ê¸°ì—¬_ë‚´ìš©` í•„ë“œê°€ **ì •í™•íˆ 200ì ì´ë‚´**
* **ìš°ì„ ìˆœìœ„**: ê¸€ììˆ˜ ì œí•œ > ëª¨ë“  ë‹¤ë¥¸ ê·œì¹™
* **ê²€ì¦**: ê° íŒ€ì›ë³„ë¡œ ê¸€ììˆ˜ë¥¼ ë°˜ë“œì‹œ í™•ì¸í•˜ê³  200ì ì´ˆê³¼ ì‹œ ê°•ì œ ë‹¨ì¶•

### ğŸ¯ ê¸€ììˆ˜ ë‹¨ì¶• ì „ëµ (ìš°ì„ ìˆœìœ„ ìˆœ)
1. **í•µì‹¬ ì •ë³´ë§Œ ë³´ì¡´**:
   - Task ìˆ˜, ë‹¬ì„±ë¥ , ê¸°ì—¬ë„ ì ìˆ˜ (í•„ìˆ˜)
   - íŒ€ ë‚´ ìˆœìœ„/ë¹„êµ (í•„ìˆ˜)
   - ì£¼ìš” Taskëª… 1-2ê°œë§Œ ì„ íƒ

2. **ì œê±° ëŒ€ìƒ**:
   - "ì´ëŸ¬í•œ ë¶„ì„ì„ í†µí•´", "í–¥í›„ ì„±ê³¼ í–¥ìƒì„ ìœ„í•´ì„œëŠ”" ë“± ì—°ê²°ì–´êµ¬
   - "í˜„ì¬", "íŠ¹íˆ", "ê·¸ëŸ¬ë‚˜", "ë”°ë¼ì„œ" ë“± ê³¼ë„í•œ ì ‘ì†ì‚¬
   - ì¤‘ë³µë˜ëŠ” ìˆ˜ì‹ì–´ë‚˜ ë¶€ì—° ì„¤ëª…
   - ê³¼ë„í•œ ìƒì„¸ ë¶„ì„ ë‚´ìš©
   - "ìƒëŒ€ì ìœ¼ë¡œ", "ì „ë°˜ì ìœ¼ë¡œ", "í˜„ì¬ ìƒí™©ì—ì„œ" ë“± ë¶ˆí•„ìš”í•œ í‘œí˜„

3. **ë¬¸ì¥ ì••ì¶•**:
   - ê¸´ ë¬¸ì¥ì„ 2-3ê°œ ì§§ì€ ë¬¸ì¥ìœ¼ë¡œ ë¶„í• 
   - í•µì‹¬ë§Œ ë‚¨ê¸°ê³  ë¶€ì—°ì„¤ëª… ì œê±°
   - ìˆ˜ì¹˜ ì¤‘ì‹¬ì˜ ê°„ê²°í•œ ì„œìˆ 

### ğŸ“ ê¸€ììˆ˜ ë‹¨ì¶• ì‹¤í–‰ ì˜ˆì‹œ
**Before (300ì+)**:
"ê¹€ê°œë°œ(SK0002)ë‹˜ì€ í˜„ì¬ 3ê°œì˜ Taskì— ì°¸ì—¬í•˜ì—¬ í‰ê·  ë‹¬ì„±ë¥  60.0%ì™€ í‰ê·  ê¸°ì—¬ë„ 40.3ì ì„ ê¸°ë¡í•˜ì˜€ìŠµë‹ˆë‹¤. íŠ¹íˆ, AI ì œì•ˆì„œ ê¸°ëŠ¥ ê³ ë„í™” ê°œë°œì—ì„œ 50%ì˜ ë‹¬ì„±ë¥ ì„ ë³´ì´ë©° 27ì ì˜ ê¸°ì—¬ë„ë¥¼ ë‚˜íƒ€ëƒˆìœ¼ë‚˜, ì´ëŠ” íŒ€ í‰ê· ì¸ 80.9%ì— ë¹„í•´ ë‚®ì€ ìˆ˜ì¹˜ì…ë‹ˆë‹¤..."

**After (200ì ì´ë‚´, ê²©ì‹ì²´ ìœ ì§€)**:
"ê¹€ê°œë°œë‹˜ì€ 3ê°œ Taskì— ì°¸ì—¬í•˜ì—¬ í‰ê·  ë‹¬ì„±ë¥  60.0%, ê¸°ì—¬ë„ 40.3ì ì„ ê¸°ë¡í•˜ì˜€ìŠµë‹ˆë‹¤. AI ì œì•ˆì„œ ê°œë°œ(50%, 27ì ), íŒ€ ê°€ë™ë¥  ëª¨ë‹ˆí„°ë§(75%, 91ì ), ì‹ ê·œ ê³ ê° ë°œêµ´(55%, 3ì )ë¡œ íŒ€ í‰ê·  80.9% ëŒ€ë¹„ ë‚®ì€ ì„±ê³¼ë¥¼ ë³´ì˜€ìŠµë‹ˆë‹¤. íŠ¹ì • ë¶„ì•¼ ê°•ì ì´ ìˆìœ¼ë‚˜ ì „ë°˜ì  ì„±ê³¼ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤."

## ê¸°ë³¸ í†¤ ë³´ì • ê·œì¹™

### 1. í˜¸ì¹­ í†µì¼
* **í†µì¼ ê¸°ì¤€**: "[ì´ë¦„]ë‹˜ì€"ìœ¼ë¡œ ì¼ê´€ì„± ìˆê²Œ ì‚¬ìš©
* **ìˆ˜ì • ëŒ€ìƒ**: "í•´ë‹¹ ì§ì›ì€" â†’ "[ì´ë¦„]ë‹˜ì€", "[ì´ë¦„]ì€" â†’ "[ì´ë¦„]ë‹˜ì€"

### 2. ë¬¸ì²´ ì¼ê´€ì„±
* **í†µì¼ ê¸°ì¤€**: ê²©ì‹ì²´(ì¡´ëŒ“ë§) ì‚¬ìš©
* **ìˆ˜ì • ëŒ€ìƒ**: í‰ì–´ì²´(~ë‹¤, ~ì˜€ë‹¤) â†’ ê²©ì‹ì²´(~ìŠµë‹ˆë‹¤, ~ì˜€ìŠµë‹ˆë‹¤)

### 3. ë°˜ë³µ í‘œí˜„ ê°œì„ 
* ë™ì¼í•œ í˜‘ì—… í‘œí˜„ì˜ ê³¼ë„í•œ ë°˜ë³µ ë°©ì§€
* ë‹¤ì–‘í•œ í‘œí˜„ìœ¼ë¡œ ë³€ê²½: "í˜‘ì—…ì„ í†µí•´" â†’ "í˜‘ë ¥í•˜ì—¬", "íŒ€ ì°¨ì›ì˜ í˜‘ë ¥ìœ¼ë¡œ"

### 4. ë¶€ì •ì  í”¼ë“œë°± ì „ë‹¬ ë°©ì‹ ê°œì„ 
* ê´€ë¦¬ì  ê´€ì ì—ì„œ ê°ê´€ì ì´ê³  ì „ëµì ì¸ í‘œí˜„ ì‚¬ìš©
* "ì‹¤ìˆ˜ê°€ ì¦ìŒ" â†’ "ì—…ë¬´ ì •í™•ì„± í–¥ìƒ í•„ìš”"

### 5. ì‹œê°„ í‘œí˜„ êµ¬ì²´í™”
* íŒ€_ê¸°ë³¸ì •ë³´ì˜ ì—…ë¬´_ìˆ˜í–‰_ê¸°ê°„ê³¼ ì¼ì¹˜ì‹œí‚¤ê¸°

## ê¸€ììˆ˜ ë‹¨ì¶•ì„ ìœ„í•œ í‘œí˜„ ë³€ê²½ ê°€ì´ë“œ

### ì••ì¶• ê°€ëŠ¥í•œ í‘œí˜„ë“¤ (ê²©ì‹ì²´ ìœ ì§€)
* "í˜„ì¬ 3ê°œì˜ Taskì— ì°¸ì—¬í•˜ì—¬" â†’ "3ê°œ Taskì— ì°¸ì—¬í•˜ì—¬"
* "í‰ê·  ë‹¬ì„±ë¥  60.0%ì™€ í‰ê·  ê¸°ì—¬ë„ 40.3ì ì„ ê¸°ë¡í•˜ì˜€ìŠµë‹ˆë‹¤" â†’ "í‰ê·  ë‹¬ì„±ë¥  60.0%, ê¸°ì—¬ë„ 40.3ì ì„ ê¸°ë¡í•˜ì˜€ìŠµë‹ˆë‹¤"
* "ì´ëŠ” íŒ€ í‰ê· ì¸ 80.9%ì— ë¹„í•´ ë‚®ì€ ìˆ˜ì¹˜ì…ë‹ˆë‹¤" â†’ "íŒ€ í‰ê·  80.9% ëŒ€ë¹„ ë‚®ì€ ì„±ê³¼ì…ë‹ˆë‹¤"
* "í–¥í›„ ì„±ê³¼ ê°œì„ ì„ ìœ„í•´ì„œëŠ”" â†’ "ì„±ê³¼ ê°œì„ ì„ ìœ„í•´ì„œëŠ”"
* "ìƒëŒ€ì ìœ¼ë¡œ ê¸ì •ì ì¸ ì„±ê³¼ë¥¼ ë³´ì˜€ìœ¼ë‚˜" â†’ "ê¸ì •ì  ì„±ê³¼ë¥¼ ë³´ì˜€ìœ¼ë‚˜"

### âš ï¸ ë¬¸ì²´ ì¼ê´€ì„± ì£¼ì˜ì‚¬í•­
* **ì ˆëŒ€ ê¸ˆì§€**: "ê¸°ë¡í–ˆë‹¤", "ë³´ì˜€ë‹¤", "í•„ìš”í•˜ë‹¤" ë“± í‰ì–´ì²´ ì‚¬ìš© ê¸ˆì§€
* **ë°˜ë“œì‹œ ì‚¬ìš©**: "ê¸°ë¡í•˜ì˜€ìŠµë‹ˆë‹¤", "ë³´ì˜€ìŠµë‹ˆë‹¤", "í•„ìš”í•©ë‹ˆë‹¤" ë“± ê²©ì‹ì²´ ìœ ì§€
* **ì••ì¶•ì‹œì—ë„**: ê²©ì‹ì²´ë¥¼ ë°˜ë“œì‹œ ìœ ì§€í•˜ë©´ì„œ ë‹¨ì¶•

### í•µì‹¬ ì •ë³´ ìš°ì„ ìˆœìœ„
1. **1ìˆœìœ„**: Task ìˆ˜, ë‹¬ì„±ë¥ , ê¸°ì—¬ë„ ì ìˆ˜
2. **2ìˆœìœ„**: íŒ€ í‰ê·  ëŒ€ë¹„ ìœ„ì¹˜
3. **3ìˆœìœ„**: ì£¼ìš” Taskëª… 1-2ê°œ
4. **4ìˆœìœ„**: ê°„ë‹¨í•œ í‰ê°€ ë° ê°œì„  ë°©í–¥

## âš ï¸ ì¤‘ìš” ì§€ì‹œì‚¬í•­

1. **ì ˆëŒ€ ê·œì¹™**: ê° íŒ€ì›ì˜ `ê¸°ì—¬_ë‚´ìš©`ì„ 200ì ì´ë‚´ë¡œ ë°˜ë“œì‹œ ë§ì¶¤
2. **ë¬¸ì²´ ì¼ê´€ì„±**: ëª¨ë“  ë¬¸ì¥ì„ ê²©ì‹ì²´(~ìŠµë‹ˆë‹¤, ~í•˜ì˜€ìŠµë‹ˆë‹¤)ë¡œ í†µì¼
3. **ìš°ì„ ìˆœìœ„**: ê¸€ììˆ˜ ì¤€ìˆ˜ + ê²©ì‹ì²´ ìœ ì§€ > ë‹¤ë¥¸ ëª¨ë“  ê·œì¹™
4. **ê²€ì¦ í•„ìˆ˜**: ì‘ë‹µ ì „ ê° íŒ€ì›ë³„ ê¸€ììˆ˜ í™•ì¸
5. **í•µì‹¬ ë³´ì¡´**: ìˆ˜ì¹˜ ë°ì´í„°ì™€ í•µì‹¬ í‰ê°€ëŠ” ìœ ì§€
6. **JSON êµ¬ì¡°**: ì™„ì „í•œ JSON í˜•íƒœë¡œ ì‘ë‹µ

### ë¬¸ì²´ ì¼ê´€ì„± ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ëª¨ë“  ë¬¸ì¥ì´ "~ìŠµë‹ˆë‹¤", "~í•˜ì˜€ìŠµë‹ˆë‹¤" ë“± ê²©ì‹ì²´ë¡œ ëë‚˜ëŠ”ê°€?
- [ ] "ê¸°ë¡í–ˆë‹¤", "ë³´ì˜€ë‹¤", "í•„ìš”í•˜ë‹¤" ë“± í‰ì–´ì²´ê°€ ì—†ëŠ”ê°€?
- [ ] ì••ì¶• ê³¼ì •ì—ì„œë„ ê²©ì‹ì²´ê°€ ìœ ì§€ë˜ì—ˆëŠ”ê°€?

## ê¸€ììˆ˜ í™•ì¸ ë°©ë²•
ì‘ë‹µí•˜ê¸° ì „ì— ë°˜ë“œì‹œ:
1. ê° íŒ€ì›ì˜ `ê¸°ì—¬_ë‚´ìš©` ê¸€ììˆ˜ë¥¼ í™•ì¸
2. 200ì ì´ˆê³¼ ì‹œ ì¶”ê°€ ë‹¨ì¶•
3. í•µì‹¬ ì •ë³´(ìˆ˜ì¹˜, ìˆœìœ„, ì£¼ìš” Task)ëŠ” ë³´ì¡´í•˜ë©´ì„œ ë‹¨ì¶•

ì•„ë˜ JSON í˜•íƒœì˜ íŒ€ì¥ìš© ì—…ë¬´ í‰ê°€ ë ˆí¬íŠ¸ì˜ í†¤ì„ ìœ„ ê·œì¹™ì— ë”°ë¼ ë³´ì •í•´ì£¼ì„¸ìš”.
**íŠ¹íˆ ì¤‘ìš”**: íŒ€ì›_ì„±ê³¼_ë¶„ì„ â†’ íŒ€ì›ë³„_ê¸°ì—¬ë„ì˜ ê° íŒ€ì›ë³„ ê¸°ì—¬_ë‚´ìš© í•„ë“œê°€ ë°˜ë“œì‹œ 200ì ì´ë‚´ê°€ ë˜ë„ë¡ ì¡°ì •í•´ì£¼ì„¸ìš”.
ì›ë³¸ JSON êµ¬ì¡°ì™€ ë°ì´í„°ëŠ” ì™„ì „íˆ ìœ ì§€í•˜ë˜, í…ìŠ¤íŠ¸ ë‚´ìš©ë§Œ ë³´ì •í•˜ì—¬ ì™„ì „í•œ JSON í˜•íƒœë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”.
"""
        
        if str(report_type) == "ManagerReportType.MANAGER_QUARTERLY":
            base_prompt += "\nì´ ë ˆí¬íŠ¸ëŠ” íŒ€ì¥ìš© ë¶„ê¸°ë³„ ë ˆí¬íŠ¸ì…ë‹ˆë‹¤."
        else:
            base_prompt += "\nì´ ë ˆí¬íŠ¸ëŠ” íŒ€ì¥ìš© ì—°ë§ ë ˆí¬íŠ¸ì…ë‹ˆë‹¤."
        
        return base_prompt
    
    def correct_tone(self, report_json: Dict[str, Any], report_type) -> str:
        """LLMì„ ì‚¬ìš©í•œ íŒ€ì¥ìš© í†¤ ë³´ì • (ê¸€ììˆ˜ ì œí•œ ê°•í™”)"""
        system_prompt = self.get_manager_tone_correction_prompt(report_type)
        
        # JSONì„ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì „ë‹¬
        report_text = json.dumps(report_json, ensure_ascii=False, indent=2)
        
        # ì¶”ê°€ì ì¸ ê¸€ììˆ˜ ì œí•œ ê°•ì¡° ë©”ì‹œì§€
        character_limit_reminder = """
âš ï¸ ê¸€ììˆ˜ ì œí•œ ì¬í™•ì¸:
- ê° íŒ€ì›ì˜ ê¸°ì—¬_ë‚´ìš©ì´ ì •í™•íˆ 200ì ì´ë‚´ì—¬ì•¼ í•©ë‹ˆë‹¤
- 200ìë¥¼ 1ê¸€ìë¼ë„ ì´ˆê³¼í•˜ë©´ ì•ˆë©ë‹ˆë‹¤
- ì‘ë‹µí•˜ê¸° ì „ì— ë°˜ë“œì‹œ ê° íŒ€ì›ë³„ë¡œ ê¸€ììˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”
- í•µì‹¬ ìˆ˜ì¹˜(ë‹¬ì„±ë¥ , ê¸°ì—¬ë„, Task ìˆ˜)ëŠ” ìœ ì§€í•˜ë©´ì„œ ìµœëŒ€í•œ ì••ì¶•í•˜ì„¸ìš”
"""
        
        try:
            messages = [
                SystemMessage(content=system_prompt),
                HumanMessage(content=character_limit_reminder + "\n\n" + report_text)
            ]
            
            response = self.client.invoke(messages)
            return response.content
            
        except Exception as e:
            print(f"LLM API ì˜¤ë¥˜: {e}")
            return report_text  # ì˜¤ë¥˜ ì‹œ ì›ë³¸ ë°˜í™˜
    
    def validate_character_limits(self, corrected_json: Dict[str, Any]) -> Dict[str, int]:
        """ê¸€ììˆ˜ ì œí•œ ê²€ì¦ ë° ìœ„ë°˜ ì •ë³´ ë°˜í™˜"""
        violations = {}
        try:
            team_analysis = corrected_json.get('íŒ€ì›_ì„±ê³¼_ë¶„ì„', {})
            team_members = team_analysis.get('íŒ€ì›ë³„_ê¸°ì—¬ë„', [])
            
            for member in team_members:
                contribution = member.get('ê¸°ì—¬_ë‚´ìš©', '')
                member_name = member.get('ì´ë¦„', 'Unknown')
                char_count = len(contribution)
                
                if char_count > 200:
                    violations[member_name] = char_count
            
        except Exception as e:
            print(f"ê¸€ììˆ˜ ê²€ì¦ ì˜¤ë¥˜: {e}")
        
        return violations